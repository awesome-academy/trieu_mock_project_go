{{define "pages/admin_user_edit.html"}}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{.title}} - {{.user.Name}}</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/admin">Admin Panel</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/admin/logout">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/admin">Admin</a></li>
          <li class="breadcrumb-item"><a href="/admin/users">Users</a></li>
          <li class="breadcrumb-item">
            <a href="/admin/users/{{.user.ID}}">{{.user.Name}}</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">Edit</li>
        </ol>
      </nav>

      {{if .error}}
      <div class="alert alert-danger" role="alert">{{.error}}</div>
      <a href="/admin/users" class="btn btn-secondary">Back to Users</a>
      {{else}}
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
              <h5 class="mb-0 fw-bold">
                <i class="bi bi-pencil-square me-2 text-primary"></i>Edit User
                Profile
              </h5>
            </div>
            <div class="card-body p-4">
              <form id="editUserForm">
                <!-- Basic Information -->
                <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">
                  Basic Information
                </h6>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="name" class="form-label fw-bold"
                      >Full Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="name"
                      name="name"
                      value="{{.user.Name}}"
                      required
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="email" class="form-label fw-bold"
                      >Email Address</label
                    >
                    <input
                      type="email"
                      class="form-control"
                      id="email"
                      name="email"
                      value="{{.user.Email}}"
                      required
                    />
                  </div>
                </div>

                <div class="row mb-4">
                  <div class="col-md-6">
                    <label for="birthday" class="form-label fw-bold"
                      >Birthday</label
                    >
                    <input type="date" class="form-control" id="birthday"
                    name="birthday" value="{{if
                    .user.Birthday}}{{.user.Birthday.Format
                    "2006-01-02"}}{{end}}">
                  </div>
                </div>

                <!-- Organization -->
                <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">
                  Organization
                </h6>
                <div class="row mb-4">
                  <div class="col-md-6">
                    <label for="position" class="form-label fw-bold"
                      >Position</label
                    >
                    <select
                      class="form-select"
                      id="position"
                      name="position_id"
                    >
                      {{$currentPosID := .user.Position.ID}} {{range
                      .positions}}
                      <option
                        value="{{.ID}}"
                        {{if
                        eq
                        .ID
                        $currentPosID}}selected{{end}}
                      >
                        {{.Name}}
                      </option>
                      {{end}}
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="team" class="form-label fw-bold"
                      >Current Team</label
                    >
                    <select class="form-select" id="team" name="team_id">
                      <option value="">No Team</option>
                      {{$currentTeamID := 0}} {{if .user.CurrentTeam}}
                      {{$currentTeamID = .user.CurrentTeam.ID}} {{end}} {{range
                      .teams}}
                      <option
                        value="{{.ID}}"
                        {{if
                        eq
                        .ID
                        $currentTeamID}}selected{{end}}
                      >
                        {{.Name}}
                      </option>
                      {{end}}
                    </select>
                  </div>
                </div>

                <!-- Skills -->
                <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">
                  Skills
                </h6>
                <div class="mb-4">
                  <div class="table-responsive">
                    <table
                      class="table table-hover align-middle"
                      id="skillsTable"
                    >
                      <thead class="table-light">
                        <tr>
                          <th>Skill Name</th>
                          <th style="width: 150px">Level (1-10)</th>
                          <th style="width: 150px">Years (0-100)</th>
                          <th style="width: 50px"></th>
                        </tr>
                      </thead>
                      <tbody id="skillsList">
                        {{range .user.Skills}}
                        <tr data-skill-id="{{.ID}}">
                          <td>{{.Name}}</td>
                          <td>
                            <select
                              class="form-select form-select-sm skill-level"
                            >
                              {{$currentLevel := .Level}} {{range $i := iterate
                              1 10}}
                              <option
                                value="{{$i}}"
                                {{if
                                eq
                                $i
                                $currentLevel}}selected{{end}}
                              >
                                {{$i}}
                              </option>
                              {{end}}
                            </select>
                          </td>
                          <td>
                            <input
                              type="number"
                              class="form-control form-control-sm skill-years"
                              value="{{.UsedYearNumber}}"
                              min="0"
                              max="100"
                            />
                          </td>
                          <td>
                            <button
                              type="button"
                              class="btn btn-outline-danger btn-sm remove-skill-btn"
                            >
                              <i class="bi bi-trash"></i>
                            </button>
                          </td>
                        </tr>
                        {{end}}
                      </tbody>
                    </table>
                  </div>

                  <div class="row g-2 align-items-center mt-2">
                    <div class="col-md-6">
                      <select class="form-select" id="newSkillSelect">
                        <option value="">-- Select Skill to Add --</option>
                        {{range .skills}}
                        <option value="{{.ID}}" data-name="{{.Name}}">
                          {{.Name}}
                        </option>
                        {{end}}
                      </select>
                    </div>
                    <div class="col-auto">
                      <button
                        type="button"
                        class="btn btn-success"
                        id="addSkillBtn"
                      >
                        <i class="bi bi-plus-lg me-1"></i>Add Skill
                      </button>
                    </div>
                  </div>
                </div>

                <div
                  class="d-flex justify-content-between align-items-center border-top pt-4"
                >
                  <a
                    href="/admin/users/{{.user.ID}}"
                    class="btn btn-outline-secondary"
                  >
                    <i class="bi bi-x-circle me-1"></i>Cancel
                  </a>
                  <button
                    type="button"
                    class="btn btn-primary px-5 fw-bold"
                    id="updateUserBtn"
                  >
                    <i class="bi bi-save me-1"></i>Update User
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      {{end}}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const skillsList = document.getElementById("skillsList");
        const newSkillSelect = document.getElementById("newSkillSelect");
        const addSkillBtn = document.getElementById("addSkillBtn");
        const updateUserBtn = document.getElementById("updateUserBtn");
        const editUserForm = document.getElementById("editUserForm");

        // Function to update the available skills in the dropdown
        function updateAvailableSkills() {
          const currentSkillIds = Array.from(
            skillsList.querySelectorAll("tr")
          ).map((tr) => tr.dataset.skillId);

          Array.from(newSkillSelect.options).forEach((option) => {
            if (option.value === "") return;
            if (currentSkillIds.includes(option.value)) {
              option.style.display = "none";
            } else {
              option.style.display = "block";
            }
          });
          newSkillSelect.value = "";
        }

        // Initial update
        updateAvailableSkills();

        // Add skill
        addSkillBtn.addEventListener("click", function () {
          const skillId = newSkillSelect.value;
          if (!skillId) return;

          const skillName =
            newSkillSelect.options[newSkillSelect.selectedIndex].dataset.name;

          const tr = document.createElement("tr");
          tr.dataset.skillId = skillId;
          tr.innerHTML = `
            <td>${skillName}</td>
            <td>
              <select class="form-select form-select-sm skill-level">
                ${Array.from({ length: 10 }, (_, i) => i + 1)
                  .map((i) => `<option value="${i}">${i}</option>`)
                  .join("")}
              </select>
            </td>
            <td>
              <input type="number" class="form-control form-control-sm skill-years" 
                value="0" min="0" max="100">
            </td>
            <td>
              <button type="button" class="btn btn-outline-danger btn-sm remove-skill-btn">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;

          skillsList.appendChild(tr);
          updateAvailableSkills();
        });

        // Remove skill
        skillsList.addEventListener("click", function (e) {
          if (e.target.closest(".remove-skill-btn")) {
            e.target.closest("tr").remove();
            updateAvailableSkills();
          }
        });

        // Update user
        updateUserBtn.addEventListener("click", async function () {
          const formData = new FormData(editUserForm);
          const data = {
            name: formData.get("name"),
            email: formData.get("email"),
            birthday: formData.get("birthday"),
            position_id: parseInt(formData.get("position_id")),
            team_id: formData.get("team_id")
              ? parseInt(formData.get("team_id"))
              : null,
            skills: [],
          };

          skillsList.querySelectorAll("tr").forEach((tr) => {
            const skillId = parseInt(tr.dataset.skillId);
            const level = parseInt(tr.querySelector(".skill-level").value);
            const years = parseInt(tr.querySelector(".skill-years").value);
            data.skills.push({
              id: skillId,
              level: level,
              used_year_number: years,
            });
          });

          try {
            const response = await fetch(`/admin/users/{{.user.ID}}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            if (response.ok) {
              window.location.href = `/admin/users/{{.user.ID}}`;
            } else {
              const err = await response.json();
              alert("Error: " + (err.error || "Failed to update user"));
            }
          } catch (error) {
            console.error("Error updating user:", error);
            alert("An error occurred while updating the user.");
          }
        });
      });
    </script>
  </body>
</html>
{{end}}
